

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>DNIKit Familiarity: Dataset Errors and Rare Samples &#8212; DNIKit 2.0.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/data_introspection/familiarity_for_rare_data_discovery';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="DNIKit Familiarity: Dataset Distribution" href="familiarity_for_dataset_distribution.html" />
    <link rel="prev" title="Familiarity" href="../../introspectors/data_introspection/familiarity.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    <p class="title logo__title">DNIKit 2.0.0 documentation</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../general/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../general/example_notebooks.html">Example Jupyter Notebooks</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">How to Use</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../how_to/dnikit_concepts.html">1. DNIKit overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how_to/connect_model.html">2. Load a model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how_to/connect_data.html">3. Load data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how_to/introspect.html">4. Introspect</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Algorithms</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../../introspectors/data_introspection.html">Data Introspectors</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2 has-children"><a class="reference internal" href="../../introspectors/data_introspection/dataset_report.html">Dataset Report</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="dataset_report.html">Jupyter Notebook: Dataset Report</a></li>
</ul>
</li>
<li class="toctree-l2 current active has-children"><a class="reference internal" href="../../introspectors/data_introspection/familiarity.html">Familiarity</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l3 current active"><a class="current reference internal" href="#">Jupyter Notebook: Familiarity for Rare Data Discovery</a></li>
<li class="toctree-l3"><a class="reference internal" href="familiarity_for_dataset_distribution.html">Jupyter Notebook: Familiarity for Comparison of Dataset Distribution</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../introspectors/data_introspection/duplicates.html">Duplicates</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="duplicates.html">Jupyter Notebook: Find Near-Duplicate Data</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../introspectors/data_introspection/dimension_reduction.html">Dimension Reduction</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="dimension_reduction.html">Jupyter Notebook: Dimension Reduction Strategies</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../introspectors/model_introspection.html">Network Introspectors</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../introspectors/model_introspection/network_compression.html">Network Compression with PFA</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../model_introspection/principal_filter_analysis.html">Jupyter Notebook: Principal Filter Analysis (PFA)</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../introspectors/model_introspection/inactive_units.html">Find Inactive Units with IUA</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../model_introspection/inactive_unit_analysis.html">Jupyter Notebook: Inactive Unit Analysis (IUA)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Utilities</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../utils/data_producers.html">Data Producers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utils/pipeline_stages.html">Batch Processors</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../api/index.html">DNIKit API</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/dnikit/index.html"><code class="docutils literal notranslate"><span class="pre">dnikit</span></code></a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-10"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/dnikit/base.html">Base API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/dnikit/processors.html">Processors API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/dnikit/introspectors.html">Introspectors API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/dnikit/exceptions.html">Exceptions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/dnikit/typing.html">Typing</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api/tensorflow/index.html"><code class="docutils literal notranslate"><span class="pre">dnikit_tensorflow</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/torch/index.html"><code class="docutils literal notranslate"><span class="pre">dnikit_torch</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/how_to_cite.html">Citing DNIKit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../general/support.html">Support</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../dev/contributing.html">Contributor’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/changelog.html">Changelog</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/data_introspection/familiarity_for_rare_data_discovery.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>DNIKit Familiarity: Dataset Errors and Rare Samples</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Set-up-a-DNIKit-model-that-is-able-to-run-inference">Set-up a DNIKit model that is able to run inference</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Create-a-DNI-Dataset-wrapping-CIFAR-10">Create a DNI Dataset wrapping CIFAR-10</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#2.-Run-inference-to-obtain-responses">2. Run inference to obtain responses</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#2.1-Reduce-the-dimensionality-using-Principal-Component-Analysis-(PCA)">2.1 Reduce the dimensionality using Principal Component Analysis (PCA)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#3.-Fit-familiarity-model">3. Fit familiarity model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#4.-Visualization">4. Visualization</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <div class="admonition note">
<p class="admonition-title">Note</p>
<p>This page was generated from a Jupyter notebook.
The original can be downloaded from
<a class="reference external" href="https://raw.github.com/apple/dnikit/main/notebooks/data_introspection/familiarity_for_rare_data_discovery.ipynb">here</a>.</p>
</div>
<section id="DNIKit-Familiarity:-Dataset-Errors-and-Rare-Samples">
<h1>DNIKit Familiarity: Dataset Errors and Rare Samples<a class="headerlink" href="#DNIKit-Familiarity:-Dataset-Errors-and-Rare-Samples" title="Permalink to this heading">#</a></h1>
<p>Using DNIKit <a class="reference external" href="https://apple.github.io/dnikit/api/dnikit/introspectors.html#dnikit.introspectors.Familiarity">Familiarity</a>, discover the least and most representative data samples in an overall dataset or within a data subgroup in order to understand dataset bias, spot outliers, and find dataset errors.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dnikit.exceptions</span> <span class="kn">import</span> <span class="n">enable_deprecation_warnings</span>

<span class="n">enable_deprecation_warnings</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># treat DNIKit deprecation warnings as errors</span>
</pre></div>
</div>
</div>
<section id="Set-up-a-DNIKit-model-that-is-able-to-run-inference">
<h2>Set-up a DNIKit model that is able to run inference<a class="headerlink" href="#Set-up-a-DNIKit-model-that-is-able-to-run-inference" title="Permalink to this heading">#</a></h2>
<p>Please see the docs for a breakdown of how to <a class="reference external" href="https://apple.github.io/dnikit/how_to/connect_model.html">load a model</a> using DNIKit. This notebook uses DNIKit’s <a class="reference external" href="https://apple.github.io/dnikit/api/dnikit_tensorflow/index.html#dnikit_tensorflow.TFModelExamples">TFModelExamples</a> to load the MobileNet model directly.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dnikit_tensorflow</span> <span class="kn">import</span> <span class="n">TFModelExamples</span>

<span class="c1"># Load CIFAR10 dataset and feed into MobileNet,</span>
<span class="c1"># observing responses from layer conv_pw_13</span>
<span class="n">mobilenet</span> <span class="o">=</span> <span class="n">TFModelExamples</span><span class="o">.</span><span class="n">MobileNet</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
2023-08-03 12:41:23.728709: I metal_plugin/src/device/metal_device.cc:1154] Metal device set to: Apple M1 Pro
2023-08-03 12:41:23.728735: I metal_plugin/src/device/metal_device.cc:296] systemMemory: 32.00 GB
2023-08-03 12:41:23.728738: I metal_plugin/src/device/metal_device.cc:313] maxCacheSize: 10.67 GB
2023-08-03 12:41:23.728771: I tensorflow/core/common_runtime/pluggable_device/pluggable_device_factory.cc:303] Could not identify NUMA node of platform GPU ID 0, defaulting to 0. Your kernel may not have been built with NUMA support.
2023-08-03 12:41:23.728785: I tensorflow/core/common_runtime/pluggable_device/pluggable_device_factory.cc:269] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 0 MB memory) -&gt; physical PluggableDevice (device: 0, name: METAL, pci bus id: &lt;undefined&gt;)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
WARNING:tensorflow:Compiled the loaded model, but the compiled metrics have yet to be built. `model.compile_metrics` will be empty until you train or evaluate the model.
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/private/tmp/dnikit-2.0.0/lib/python3.9/site-packages/keras/src/engine/training.py:3000: UserWarning: You are saving your model as an HDF5 file via `model.save()`. This file format is considered legacy. We recommend using instead the native Keras format, e.g. `model.save(&#39;my_model.keras&#39;)`.
  saving_api.save_model(
</pre></div></div>
</div>
</section>
<section id="Create-a-DNI-Dataset-wrapping-CIFAR-10">
<h2>Create a DNI Dataset wrapping CIFAR-10<a class="headerlink" href="#Create-a-DNI-Dataset-wrapping-CIFAR-10" title="Permalink to this heading">#</a></h2>
<p>Download the CIFAR-10 dataset and create 2 sub-datasets to illustrate the familiarity concept.</p>
<ul class="simple">
<li><p><strong>datasets[“cars”]:</strong> Will contain 300 images of automobiles from the training set.</p></li>
<li><p><strong>datasets[“mixed”]:</strong> Will contain 300 images randomly sampled across all classes in the test set.</p></li>
</ul>
<p>Wrap the data into a DNIKit <a class="reference external" href="https://apple.github.io/dnikit/api/dnikit/base.html#dnikit.base.Producer">Producer</a> in order to use CIFAR-10 in DNIKit. This example uses DNIKit’s <a class="reference external" href="https://apple.github.io/dnikit/api/dnikit_tensorflow/index.html#dnikit_tensorflow.TFDatasetExamples">TFDatasetExamples</a> to grab a built-in CIFAR-10 Producer. For defining a custom dataset, please see the docs for more information about how to <a class="reference external" href="https://apple.github.io/dnikit/how_to/connect_data.html">load data</a>
into DNIKit. This might include implementing a custom <a class="reference external" href="https://apple.github.io/dnikit/api/dnikit/base.html#dnikit.base.Producer">Producer</a> or using another built-in Producer (e.g. <a class="reference external" href="https://apple.github.io/dnikit/api/dnikit/base.html#dnikit.base.ImageProducer">ImageProducer</a> to load images from disk).</p>
<p>Moreover, MobileNet accepts images of size <code class="docutils literal notranslate"><span class="pre">224x224</span></code>, so it’s necessary to pre-process the CIFAR-10 images by resizing them from <code class="docutils literal notranslate"><span class="pre">32x32</span></code> to <code class="docutils literal notranslate"><span class="pre">224x224</span></code>. DNIKit provides a set of processors in the module <code class="docutils literal notranslate"><span class="pre">dnikit.processors</span></code>. Here, <a class="reference external" href="https://apple.github.io/dnikit/api/dnikit/processors.html#dnikit.processors.ImageResizer">ImageResizer</a> is used in a <a class="reference external" href="https://apple.github.io/dnikit/api/dnikit/base.html#dnikit.base.pipeline">pipeline</a> that applies such pre-processing on top of CIFAR-10.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dnikit.processors</span> <span class="kn">import</span> <span class="n">ImageResizer</span><span class="p">,</span> <span class="n">SnapshotSaver</span>
<span class="kn">from</span> <span class="nn">dnikit.base</span> <span class="kn">import</span> <span class="n">Batch</span><span class="p">,</span> <span class="n">PixelFormat</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">,</span> <span class="n">ImageFormat</span>
<span class="kn">from</span> <span class="nn">dnikit_tensorflow</span> <span class="kn">import</span> <span class="n">TFDatasetExamples</span>

<span class="c1"># Load CIFAR-10 with train and test datasets, and</span>
<span class="c1"># attach metadata (labels, dataset origins, image filepaths) to each batch</span>
<span class="n">cifar10</span> <span class="o">=</span> <span class="n">TFDatasetExamples</span><span class="o">.</span><span class="n">CIFAR10</span><span class="p">(</span><span class="n">attach_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">mobilenet_preprocessor</span> <span class="o">=</span> <span class="n">mobilenet</span><span class="o">.</span><span class="n">preprocessing</span>
<span class="k">assert</span> <span class="n">mobilenet_preprocessor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<span class="c1"># Create pre-processing pipeline</span>
<span class="n">preprocessing_stages</span> <span class="o">=</span> <span class="p">(</span>
    <span class="c1"># Save a snapshot of the raw image data to refer back to later</span>
    <span class="n">SnapshotSaver</span><span class="p">(),</span>

    <span class="c1"># Preprocess the image batches in the manner expected by MobileNet</span>
    <span class="n">mobilenet_preprocessor</span><span class="p">,</span>

    <span class="c1"># Resize images to fit the input of MobileNet, (224, 224) using an ImageResizer</span>
    <span class="n">ImageResizer</span><span class="p">(</span><span class="n">pixel_format</span><span class="o">=</span><span class="n">ImageFormat</span><span class="o">.</span><span class="n">HWC</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">)),</span>
<span class="p">)</span>

<span class="c1"># Create producers for subsets of the dataset</span>
<span class="n">datasets</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

<span class="c1"># Create producer with just 300 samples of automobiles</span>
<span class="c1"># :: Note: The subset method will filter the batch LABELS metadata matching the provided dict</span>
<span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;cars&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cifar10</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;automobile&quot;</span><span class="p">],</span> <span class="n">datasets</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">],</span> <span class="n">max_samples</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

<span class="c1"># Create producer with 300 random samples from all other classes in the test set</span>
<span class="c1"># :: Note: Pull from the test set to ensure no overlap with the &quot;cars&quot; subset</span>
<span class="n">non_car_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">cifar10</span><span class="o">.</span><span class="n">str_to_label_idx</span><span class="p">()</span> <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;automobile&quot;</span><span class="p">]</span>
<span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;mixed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cifar10</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">non_car_labels</span><span class="p">,</span> <span class="n">datasets</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">],</span> <span class="n">max_samples</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;mixed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shuffle</span><span class="p">()</span>  <span class="c1"># shuffle data samples</span>
</pre></div>
</div>
</div>
</section>
<section id="2.-Run-inference-to-obtain-responses">
<h2>2. Run inference to obtain responses<a class="headerlink" href="#2.-Run-inference-to-obtain-responses" title="Permalink to this heading">#</a></h2>
<p>This is a very important step in DNIKit. Define how responses are being pulled from the model as data is being fed. Also define how responses are post-processed so they have the dimensionality that suits the task.</p>
<p>For that, a dictionary of <a class="reference external" href="https://apple.github.io/dnikit/api/dnikit/base.html#dnikit.base.Producer">Producers</a> is created from the dataset plus a processing/inference pipeline. In this example, a <a class="reference external" href="https://apple.github.io/dnikit/api/dnikit/processors.html#dnikit.processors.Pooler">Pooler</a> is used to post-process the data.</p>
<p><em>For more details about this step please check</em> <a class="reference internal" href="../model_introspection/principal_filter_analysis.html"><span class="doc">the PFA Basic CNN Example Notebook</span></a><em>, which contains a graphical explanation of this step.</em></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dnikit.processors</span> <span class="kn">import</span> <span class="n">Pooler</span>

<span class="c1"># convert the datasets (t.Mapping[str, Producer]) into a new t.Mapping[str, Producer]</span>
<span class="c1"># describing the processing pipeline.  Remember, the Producer is a promise for data,</span>
<span class="c1"># not the result of processing.</span>
<span class="n">producers</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">dataset_name</span><span class="p">,</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">producers</span><span class="p">[</span><span class="n">dataset_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">(</span>
        <span class="c1"># Source of data -- this is either datasets[&quot;cars&quot;] or datasets[&quot;mixed&quot;]</span>
        <span class="n">dataset</span><span class="p">,</span>

        <span class="c1"># Unwrap preprocessing into the pipeline</span>
        <span class="o">*</span><span class="n">preprocessing_stages</span><span class="p">,</span>

        <span class="c1"># Run inference -- pass a list of requested responses or a single string</span>
        <span class="n">mobilenet</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="s1">&#39;conv_pw_13&#39;</span><span class="p">),</span>

        <span class="c1"># Perform spatial max pooling on the result</span>
        <span class="c1"># For max pooling, use `method=Pooler.Method.MAX`,</span>
        <span class="n">Pooler</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="n">Pooler</span><span class="o">.</span><span class="n">Method</span><span class="o">.</span><span class="n">AVERAGE</span><span class="p">),</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<section id="2.1-Reduce-the-dimensionality-using-Principal-Component-Analysis-(PCA)">
<h3>2.1 Reduce the dimensionality using Principal Component Analysis (PCA)<a class="headerlink" href="#2.1-Reduce-the-dimensionality-using-Principal-Component-Analysis-(PCA)" title="Permalink to this heading">#</a></h3>
<p>The responses created earlier will be of dimension 1024 per image. This seems too high for CIFAR images. Remember that the MobileNet model used was trained for Imagenet.</p>
<p>DNIKit contains a <a class="reference external" href="https://apple.github.io/dnikit/api/dnikit/base.html#dnikit.introspectors.DimensionReduction">DimensionReduction</a> Introspector that can help us reduce the dimensionality of the model’s responses. In this case, use the <a class="reference external" href="https://apple.github.io/dnikit/api/dnikit/base.html#dnikit.introspectors.DimensionReduction.Strategy.PCA">PCA</a> strategy to fit a PCA model on the automobile data, and then use it in a
<a class="reference external" href="https://apple.github.io/dnikit/api/dnikit/base.html#dnikit.base.pipeline">pipeline</a> to project all the responses to a length of 40.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dnikit.introspectors</span> <span class="kn">import</span> <span class="n">DimensionReduction</span>

<span class="c1"># Configure the DimensionReduction Introspector that will be used to reduce the dimensionality of the data from 1024 to 40</span>
<span class="n">n_dim</span> <span class="o">=</span> <span class="mi">40</span>

<span class="c1"># fit the PCA model on the cars</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Fitting PCA to </span><span class="si">{</span><span class="n">n_dim</span><span class="si">}</span><span class="s1"> dimensions, might take some seconds or minutes ...&#39;</span><span class="p">)</span>
<span class="n">pca</span> <span class="o">=</span> <span class="n">DimensionReduction</span><span class="o">.</span><span class="n">introspect</span><span class="p">(</span><span class="n">producers</span><span class="p">[</span><span class="s2">&quot;cars&quot;</span><span class="p">],</span> <span class="n">strategies</span><span class="o">=</span><span class="n">DimensionReduction</span><span class="o">.</span><span class="n">Strategy</span><span class="o">.</span><span class="n">PCA</span><span class="p">(</span><span class="n">n_dim</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done.&#39;</span><span class="p">)</span>

<span class="c1"># the PCA object is another `PipelineStage` that can be used to transform batches to</span>
<span class="c1"># lower dimension data.  Convert the producers (t.Mapping[str, Producer]) into</span>
<span class="c1"># a new dictionary with each of those Producers dimension-reduced via the pca object.</span>
<span class="n">reduced_producers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># compose producers[name] with pca</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">pipeline</span><span class="p">(</span><span class="n">producer</span><span class="p">,</span> <span class="n">pca</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">producer</span> <span class="ow">in</span> <span class="n">producers</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Fitting PCA to 40 dimensions, might take some seconds or minutes ...
Done.
</pre></div></div>
</div>
</section>
</section>
<section id="3.-Fit-familiarity-model">
<h2>3. Fit familiarity model<a class="headerlink" href="#3.-Fit-familiarity-model" title="Permalink to this heading">#</a></h2>
<p>Fit a gaussian mixture model in high dimensional space (obtained after PCA) on the 🚗 dataset. The model will capture the dense areas of the dataset, called <em>familiar</em>.</p>
<p>Using the fitted model, <em>score</em> the images of a dataset as being familiar or not to cars 🚗: call this <code class="docutils literal notranslate"><span class="pre">fam(data</span> <span class="pre">|</span> <span class="pre">🚗)</span></code>.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">fam(🚗</span> <span class="pre">|</span> <span class="pre">🚗)</span></code>: The most common cars in the dataset are expected to have high familiarity. The cars with low familiarity are those that are not well represented in the dataset (typically corner cases, strange viewpoints, etc).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fam(mixed</span> <span class="pre">|</span> <span class="pre">🚗)</span></code>: The mixed dataset will likely have a few cars, expected to have high familiarity. Also the images of the “truck” class will probably have high familiarity with cars. On the other hand, images of forest and animals will probably have lower familiarity.</p></li>
</ul>
<p>Familiarity can be used to spot corner cases and wrong annotations quickly!</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dnikit.introspectors</span> <span class="kn">import</span> <span class="n">Familiarity</span>

<span class="c1"># Fit the familiarity model on the dimension reduced automobile 🚗 class of images</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fitting Familiarity, might take some seconds or minutes ...&#39;</span><span class="p">)</span>

<span class="c1"># Use the Familiarity.Strategy.GMM strategy by default</span>
<span class="n">familiarity</span> <span class="o">=</span> <span class="n">Familiarity</span><span class="o">.</span><span class="n">introspect</span><span class="p">(</span><span class="n">reduced_producers</span><span class="p">[</span><span class="s2">&quot;cars&quot;</span><span class="p">])</span>

<span class="c1"># the familiarity object is something that can score responses (per layer) according to the model that was just</span>
<span class="c1"># trained.  it puts these scores (density) into metadata attached to the batch.  a higher score means</span>
<span class="c1"># more familiar and a lower score means less familiar.</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done fitting Familiarity.&#39;</span><span class="p">)</span>

<span class="c1"># Define how to score the 🚗 and mixed datasets according to the 🚗 familiarity model.</span>
<span class="c1">#</span>
<span class="c1"># now score the cars and mixed (dimension reduced) datasets with respect to</span>
<span class="c1"># the familiarity model that was just computed.  Use reduced_producers (t.Mapping[str, Producer])</span>
<span class="c1"># and compose it with familiarity to produce a new scored_producers.</span>
<span class="n">scored_producers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># compose reduced_producers[name] with familiarity</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">pipeline</span><span class="p">(</span><span class="n">producer</span><span class="p">,</span> <span class="n">familiarity</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">producer</span> <span class="ow">in</span> <span class="n">reduced_producers</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Fitting Familiarity, might take some seconds or minutes ...
Done fitting Familiarity.
</pre></div></div>
</div>
</section>
<section id="4.-Visualization">
<h2>4. Visualization<a class="headerlink" href="#4.-Visualization" title="Permalink to this heading">#</a></h2>
<p>Once the density scores are computed, there are different ways to visualize them. One way would be to use the <a class="reference external" href="https://apple.github.io/dnikit/introspectors/data_introspection/dataset_report.html">DatasetReport</a>’s recommended way: with <a class="reference external" href="https://github.com/apple/ml-symphony">Symphony</a>.</p>
<p>For this notebook, define a simple class to hold the image data and the density score, that can bee sorted and displayed using matplotlib.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dataclasses</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">typing</span> <span class="k">as</span> <span class="nn">t</span>

<span class="kn">from</span> <span class="nn">dnikit.base</span> <span class="kn">import</span> <span class="n">Producer</span>

<span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">FamiliarityResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class to encapsulate the familiarity data and image.&quot;&quot;&quot;</span>
    <span class="n">density_score</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">axarr</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add the image and score to the axes of a plot&quot;&quot;&quot;</span>
        <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">NullLocator</span><span class="p">())</span>
        <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">NullLocator</span><span class="p">())</span>
        <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">density_score</span><span class="si">:</span><span class="s1">0.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">producer</span><span class="p">:</span> <span class="n">Producer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="s2">&quot;FamiliarityResult&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct a list of FamiliarityResult from a Producer&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">FamiliarityResult</span><span class="p">(</span>
                <span class="c1"># pull the original raster data from the input attached to the snapshot</span>
                <span class="n">img</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">snapshots</span><span class="p">[</span><span class="s2">&quot;snapshot&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">],</span>

                <span class="c1"># and the scores are attached to the Familiarity.DENSITY_KEY metadata on the output field</span>
                <span class="n">density_score</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">familiarity</span><span class="o">.</span><span class="n">meta_key</span><span class="p">][</span><span class="s2">&quot;conv_pw_13&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">score</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">producer</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
        <span class="p">]</span>

<span class="c1"># produced sorted results in descending order -- note that this is actually evaluating the producers</span>
<span class="c1"># in the call to build()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Scoring and sorting data. This may take several seconds...&#39;</span><span class="p">)</span>
<span class="n">sorted_automobile</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">FamiliarityResult</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">scored_producers</span><span class="p">[</span><span class="s2">&quot;cars&quot;</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sorted_mixed</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">FamiliarityResult</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">scored_producers</span><span class="p">[</span><span class="s2">&quot;mixed&quot;</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Scoring and sorting data. This may take several seconds...
Done.
</pre></div></div>
</div>
<p>Show the top-10 and bottom-10 familiar images with respect to the 🚗 familiarity model.</p>
<ul class="simple">
<li><p>See how the least familiar cars are “less canonical” than the most familiar ones. This may indicate that more cars like these ones should be collected to enforce diversity.</p></li>
<li><p>Check how the most familiar images from the mixed dataset are mostly cars and trucks. On the other hand, the leas familiar ones are mostly animals.</p></li>
<li><p>There is a car in the least familiar mixed images. However, that car has a tilted viewpoint, which makes it less familiar.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">show_results</span><span class="p">(</span><span class="n">results</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">FamiliarityResult</span><span class="p">],</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">axarr</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
        <span class="n">result</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">axarr</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;==================</span><span class="se">\n</span><span class="s1">fam(🚗 | 🚗)</span><span class="se">\n</span><span class="s1">==================</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">show_results</span><span class="p">(</span><span class="n">sorted_automobile</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Automobile most familiar&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">show_results</span><span class="p">(</span><span class="n">sorted_automobile</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:],</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Automobile least familiar&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;==================</span><span class="se">\n</span><span class="s1">fam(mixed | 🚗)</span><span class="se">\n</span><span class="s1">==================</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">show_results</span><span class="p">(</span><span class="n">sorted_mixed</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Mixed most familiar&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">show_results</span><span class="p">(</span><span class="n">sorted_mixed</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:],</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Mixed least familiar&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
==================
fam(🚗 | 🚗)
==================

Automobile most familiar
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_data_introspection_familiarity_for_rare_data_discovery_15_1.png" src="../../_images/notebooks_data_introspection_familiarity_for_rare_data_discovery_15_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Automobile least familiar
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_data_introspection_familiarity_for_rare_data_discovery_15_3.png" src="../../_images/notebooks_data_introspection_familiarity_for_rare_data_discovery_15_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
==================
fam(mixed | 🚗)
==================

Mixed most familiar
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_data_introspection_familiarity_for_rare_data_discovery_15_5.png" src="../../_images/notebooks_data_introspection_familiarity_for_rare_data_discovery_15_5.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Mixed least familiar
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_data_introspection_familiarity_for_rare_data_discovery_15_7.png" src="../../_images/notebooks_data_introspection_familiarity_for_rare_data_discovery_15_7.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>


                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="../../introspectors/data_introspection/familiarity.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Familiarity</p>
      </div>
    </a>
    <a class="right-next"
       href="familiarity_for_dataset_distribution.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">DNIKit Familiarity: Dataset Distribution</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Set-up-a-DNIKit-model-that-is-able-to-run-inference">Set-up a DNIKit model that is able to run inference</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Create-a-DNI-Dataset-wrapping-CIFAR-10">Create a DNI Dataset wrapping CIFAR-10</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#2.-Run-inference-to-obtain-responses">2. Run inference to obtain responses</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#2.1-Reduce-the-dimensionality-using-Principal-Component-Analysis-(PCA)">2.1 Reduce the dimensionality using Principal Component Analysis (PCA)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#3.-Fit-familiarity-model">3. Fit familiarity model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#4.-Visualization">4. Visualization</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Apple, Inc.
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2023 Apple Inc. All rights reserved..
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>